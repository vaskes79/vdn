# Архитектура проекта VDN

## Общая архитектура

VDN (Video Notes) - это одностраничное React-приложение (SPA) для просмотра видео с YouTube и Vimeo с возможностью создания заметок с временными метками. Все данные хранятся локально в браузере с использованием IndexedDB.

## Технологический стек

- **React** (v16.10.2) - UI библиотека
- **TypeScript** (v4.0.2) - типизация для части компонентов
- **Material-UI** (v4.5.1) - компоненты интерфейса
- **react-player** (v1.13.0) - проигрыватель видео
- **idb** (v4.0.5) - библиотека для работы с IndexedDB
- **react-scripts** (v3.2.0) - инструменты сборки Create React App

## Компонентная структура

### Иерархия компонентов

```
VdnApp (Root)
├── NavBar
│   ├── Sidebar
│   │   └── SidebarList
│   │       └── SidebarItem
│   └── AddVideo (Dialog)
├── Main
│   ├── MainLeft
│   │   └── Video (react-player)
│   └── MainRight
│       └── Notes
│           ├── Controls
│           ├── AddNoteForm
│           └── NoteList
│               └── NoteItem
│                   ├── Edit (Dialog)
│                   └── Confirm (Dialog)
└── Footer
    ├── FooterLeft
    └── FooterRight
```

### Описание компонентов

#### VdnApp (`src/components/VdnApp/VdnApp.js`)

- Корневой компонент приложения
- Создает экземпляр `IndexDBConnector` для работы с БД
- Управляет глобальным состоянием через Context API
- Предоставляет контекст `VdnAppContext` для дочерних компонентов
- Состояние компонента:
  - `playing` - статус воспроизведения видео
  - `urlVideo` - URL текущего видео
  - `updateVer` - версия для принудительного обновления данных
  - `notes` - список заметок для текущего видео
  - `player` - ссылка на компонент проигрывателя

#### NavBar (`src/components/NavBar/NavBar.js`)

- Навигационная панель в верхней части приложения
- Содержит Sidebar и кнопку добавления видео
- Использует Material-UI AppBar

#### Sidebar (`src/components/Sidebar/Sidebar.js`)

- Боковая панель со списком добавленных видео
- Открывается/закрывается через Drawer компонент
- При открытии останавливает воспроизведение видео
- Загружает список видео из IndexedDB

#### Video (`src/components/Video/Video.js`)

- Компонент проигрывателя видео на базе `react-player`
- Поддерживает YouTube и Vimeo
- Использует `forwardRef` для доступа к методам проигрывателя
- Высота рассчитывается динамически: `window.innerHeight - 150px`

#### Notes (`src/components/Notes/Notes.js`)

- Контейнер для управления заметками
- Содержит форму добавления заметки, список заметок и кнопки экспорта
- Получает список заметок из контекста

#### Dialog компоненты (`src/components/Dialog/`)

- **AddVideo** - диалог добавления нового видео
- **Edit** - диалог редактирования заметки или видео
- **Confirm** - диалог подтверждения удаления
- **Info** - информационный диалог

## Управление состоянием

### Context API

Приложение использует React Context API для передачи состояния и методов между компонентами.

**VdnAppContext** (`src/components/VdnApp/context.js`):

- Создается через `createContext()`
- Предоставляет глобальное состояние и методы:
  - `updateVer` - версия для обновления
  - `player` - ссылка на проигрыватель
  - `playing` - статус воспроизведения
  - `notes` - массив заметок
  - `getCurrentTime()` - получение текущего времени видео
  - `goToTime(time)` - переход к указанному времени
  - `setPlaying` - установка статуса воспроизведения
  - `urlVideo` - URL текущего видео
  - `update()` - принудительное обновление данных
  - `setUrlVideo(url)` - установка URL видео
  - `db` - экземпляр IndexDBConnector

### Механизм обновления данных

Для синхронизации данных между компонентами используется механизм версионирования:

- При изменении данных вызывается `update()` из контекста
- Это увеличивает `updateVer`, что вызывает перезагрузку данных в компонентах через `useEffect`

## Работа с данными (IndexedDB)

### Структура базы данных

База данных создается через библиотеку `idb` с именем `VDN` (версия 3).

#### Таблица SETTINGS

- **Ключ**: `id` (autoIncrement)
- **Индекс**: `by_name` (unique)
- **Назначение**: Хранение настроек приложения
- **Записи**:
  - `html` - включение/выключение экспорта в HTML
  - `md` - включение/выключение экспорта в Markdown
  - `txt` - включение/выключение экспорта в Text
  - `time_offset` - смещение времени при создании заметки (по умолчанию 3 секунды)
  - `current_video` - URL текущего активного видео

#### Таблица LIST_VIDEO

- **Ключ**: `url` (уникальный)
- **Индексы**:
  - `by_title` - по названию
  - `by_url` - по URL (unique)
- **Назначение**: Список добавленных видео
- **Структура записи**:
  ```typescript
  {
    url: string;
    title: string;
  }
  ```

#### Таблица NOTES

- **Ключ**: `id` (autoIncrement)
- **Индекс**: `by_url` - по URL видео
- **Назначение**: Заметки с временными метками
- **Структура записи**:
  ```typescript
  {
    id: number;
    url: string; // URL видео
    title: string; // Текст заметки
    time: number; // Время в секундах
  }
  ```

### IndexDBConnector (`src/components/db/IndexDBConnector.ts`)

Класс для работы с IndexedDB, предоставляет методы:

- **Управление настройками**:

  - `setSettings(name, value)` - установка настройки
  - `getCurrentVideo()` - получение текущего видео
  - `setCurrentVideo(value)` - установка текущего видео

- **Управление видео**:

  - `addVideo(video)` - добавление видео
  - `removeVideo(urlID)` - удаление видео и всех связанных заметок
  - `editVideo(urlID, title)` - редактирование названия видео
  - `getVideoList()` - получение списка всех видео

- **Управление заметками**:
  - `addNote(noteItem)` - добавление заметки
  - `removeNote(id)` - удаление заметки
  - `editNote(urlID, title)` - редактирование заметки
  - `getNoteList(url)` - получение списка заметок (для конкретного видео или всех)

### Инициализация БД (`src/components/db/indexDBsetup.ts`)

При первом запуске приложения создается база данных с демо-данными:

- Демо-видео с URL `https://youtu.be/cCOL7MC4Pl0`
- Примеры заметок для демонстрации функциональности

## Потоки данных

### Добавление видео

1. Пользователь открывает диалог `AddVideo`
2. Вводит название и URL видео
3. При подтверждении:
   - Вызывается `db.addVideo(video)`
   - Вызывается `db.setCurrentVideo(url)`
   - Обновляется `urlVideo` в контексте
   - Вызывается `update()` для обновления списка видео

### Создание заметки

1. Пользователь вводит текст в `AddNoteForm`
2. При отправке формы:
   - Получается текущее время видео через `getCurrentTime()`
   - Вычитается `TIME_OFFSET` (3 секунды по умолчанию)
   - Создается объект заметки с URL видео, текстом и временем
   - Вызывается `db.addNote(noteItem)`
   - Вызывается `update()` для обновления списка заметок

### Переход к моменту видео

1. Пользователь кликает на заметку в `NoteItem`
2. Вызывается `goToTime(time)` из контекста
3. Проигрыватель переходит к указанному времени через `player.current.seekTo(time)`

### Экспорт заметок

1. Пользователь выбирает формат (HTML, Markdown, Text)
2. Вызывается соответствующая функция форматирования из `utils.js`
3. Форматированные данные копируются в буфер обмена через `copyToClipBoard()`

## Утилиты (`src/components/utils.js`)

- `formatTime(duration)` - форматирование времени в формат `HH:MM:SS`
- `formatToHtml(notes)` - форматирование заметок в HTML список
- `formatToMarkdown(notes)` - форматирование заметок в Markdown
- `formatToText(notes)` - форматирование заметок в текстовый формат
- `getVideoUrl(url, time)` - генерация URL с временной меткой для YouTube/Vimeo
- `copyToClipBoard(el)` - копирование текста в буфер обмена

## Константы (`src/components/constants.ts`)

Файл содержит enum `AppSetup` с константами:

- `NAME` - имя БД ("VDN")
- `VER` - версия БД (3)
- `LIST` - название таблицы видео ("LIST_VIDEO")
- `NOTES` - название таблицы заметок ("NOTES")
- `SETTINGS` - название таблицы настроек ("SETTINGS")
- `TIME_OFFSET` - смещение времени при создании заметки (3 секунды)

## Стилизация

Приложение использует Material-UI для стилизации:

- Каждый компонент имеет свой файл `styles.js`
- Стили применяются через HOC `withStyles()` или хук `useStyles()`
- Используется единая тема Material-UI, созданная в `src/index.tsx`

## Особенности реализации

1. **Смешанное использование JS и TS**: Проект использует и JavaScript, и TypeScript файлы. Типы определены в `src/components/db/inteface.d.ts`

2. **Управление воспроизведением**: При открытии диалоговых окон воспроизведение видео останавливается для улучшения UX

3. **Автоматическое обновление**: При изменении данных через `update()` все компоненты автоматически перезагружают данные из БД

4. **Обработка удаления видео**: При удалении видео автоматически удаляются все связанные заметки через курсор IndexedDB

5. **Временное смещение**: При создании заметки время уменьшается на `TIME_OFFSET` секунд для компенсации задержки пользователя
